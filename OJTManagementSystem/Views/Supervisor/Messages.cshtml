@model PrivateChatViewModel

@{
    ViewData["Title"] = "Messages";
    var controllerName = ViewContext.RouteData.Values["controller"].ToString();
    var currentUserId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
}

<div class="container-fluid mt-4">
    <div class="row h-100">
        <!-- Messages List Sidebar -->
        <div class="col-md-4 mb-3 mb-md-0">
            <div class="card" style="height: 600px; overflow-y: auto;">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-chat-left-dots"></i> Messages
                    </h5>
                    <a href="@Url.Action("AllChats", controllerName)" class="btn btn-sm btn-light">
                        <i class="bi bi-arrow-left"></i> Back
                    </a>
                </div>
                <div class="list-group list-group-flush">
                    @if (Model?.Messages?.Count > 0)
                    {
                        var conversations = Model.Messages
                        .GroupBy(m => m.SenderId == currentUserId ? m.ReceiverId : m.SenderId)
                        .Select(g => new
                        {
                            UserId = g.Key,
                            LastMessage = g.OrderByDescending(m => m.CreatedAt).First(),
                            UnreadCount = g.Count(m => !m.IsRead && m.ReceiverId == currentUserId)
                        })
                        .OrderByDescending(c => c.LastMessage.CreatedAt);

                        foreach (var conv in conversations)
                        {
                            var isActive = Model.OtherUserId == conv.UserId;
                            <a href="@Url.Action("PrivateChat", controllerName, new { userId = conv.UserId })"
                               class="list-group-item list-group-item-action @(isActive ? "active" : "")">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center gap-2 mb-1">
                                            <!-- ✅ Online Status Indicator -->
                                            <span class="online-status" data-user-id="@conv.UserId"></span>
                                            <h6 class="mb-0 @(isActive ? "text-white" : "")">
                                                @(conv.LastMessage.SenderId == currentUserId
                                                                                        ? conv.LastMessage.ReceiverName
                                                                                        : conv.LastMessage.SenderName)
                                            </h6>
                                        </div>
                                        <p class="mb-0 small text-truncate @(isActive ? "text-white-50" : "text-muted")">
                                            @if (conv.LastMessage.SenderId == currentUserId)
                                            {
                                                <span>You: </span>
                                            }
                                            @conv.LastMessage.MessageContent
                                        </p>
                                    </div>
                                    <div class="text-end">
                                        <small class="@(isActive ? "text-white-50" : "text-muted")">
                                            @conv.LastMessage.CreatedAt.ToString("MMM d")
                                        </small>
                                        @if (conv.UnreadCount > 0)
                                        {
                                            <br />
                                            <span class="badge bg-danger rounded-pill">@conv.UnreadCount</span>
                                        }
                                    </div>
                                </div>
                            </a>
                        }
                    }
                    else
                    {
                        <div class="text-center text-muted p-4">
                            <p>No messages yet</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="col-md-8">
            @if (Model?.OtherUserId != null)
            {
                <div class="card" style="height: 600px; display: flex; flex-direction: column;">
                    <!-- Chat Header with Online Status -->
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-2">
                            <!-- ✅ Online Status in Header -->
                            <span class="online-status-large" data-user-id="@Model.OtherUserId"></span>
                            <div>
                                <h5 class="mb-0">@Model.OtherUserName</h5>
                                <small class="online-status-text" data-user-id="@Model.OtherUserId">Offline</small>
                            </div>
                        </div>
                        <div>
                            <a href="@Url.Action("AllChats", controllerName)" class="btn btn-sm btn-light">
                                <i class="bi bi-x-circle"></i> Close
                            </a>
                        </div>
                    </div>

                    <!-- Messages Display Area -->
                    <div class="card-body" style="flex: 1; overflow-y: auto; background-color: #f8f9fa;" id="messageArea">
                        @if (Model?.Messages?.Count > 0)
                        {
                            foreach (var message in Model.Messages.OrderBy(m => m.CreatedAt))
                            {
                                var isOwn = message.SenderId == currentUserId;
                                <div class="mb-3 d-flex @(isOwn ? "justify-content-end" : "justify-content-start")">
                                    <div class="message-bubble @(isOwn ? "message-own" : "message-other")" data-message-id="@message.ChatMessageId">
                                        @if (!isOwn)
                                        {
                                            <div class="message-sender fw-bold mb-1">@message.SenderName</div>
                                        }
                                        <div class="message-content">
                                            @message.MessageContent
                                        </div>
                                        <div class="message-footer d-flex align-items-center justify-content-between mt-1">
                                            <small class="message-time">
                                                @message.CreatedAt.ToString("h:mm tt")
                                            </small>
                                            @if (isOwn)
                                            {
                                                <span class="message-status ms-2">
                                                    @if (message.IsRead)
                                                    {
                                                        <!-- ✅ Double check - Read (Blue) -->
                                                        <i class="bi bi-check-all text-primary" title="Read"></i>
                                                    }
                                                    else
                                                    {
                                                        <!-- ✅ Single check - Delivered (Gray) -->
                                                        <i class="bi bi-check text-muted" title="Delivered"></i>
                                                    }
                                                </span>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-center text-muted mt-5">
                                <p><i class="bi bi-chat-dots" style="font-size: 3rem;"></i></p>
                                <p>Start a conversation</p>
                            </div>
                        }
                    </div>

                    <!-- Message Input Area -->
                    <div class="card-footer border-top bg-white">
                        <form asp-action="SendPrivateMessage" asp-controller="@controllerName" method="post" class="d-flex gap-2" id="messageForm">
                            <input type="hidden" name="receiverId" value="@Model.OtherUserId" />
                            <input type="text" name="messageContent" id="messageInput" class="form-control"
                                   placeholder="Type your message..." required maxlength="1000" autofocus />
                            <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i></button>
                        </form>
                    </div>
                </div>
            }
            else
            {
                <div class="card" style="height: 600px;">
                    <div class="card-body d-flex align-items-center justify-content-center">
                        <div class="text-center text-muted">
                            <p><i class="bi bi-chat-dots" style="font-size: 4rem;"></i></p>
                            <h5>Select a conversation</h5>
                            <p>Choose a conversation from the list to start chatting</p>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<style>
    /* ═══════════════════════════════════════════════════════════
           ONLINE STATUS INDICATORS
           ═══════════════════════════════════════════════════════════ */

    /* Small indicator for sidebar */
    .online-status {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: #6c757d; /* Offline - gray */
        border: 2px solid white;
        flex-shrink: 0;
    }

        .online-status.online {
            background-color: #28a745; /* Online - green */
            box-shadow: 0 0 6px rgba(40, 167, 69, 0.8);
        }

    /* Large indicator for chat header */
    .online-status-large {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background-color: #6c757d; /* Offline - gray */
        border: 2px solid white;
        flex-shrink: 0;
    }

        .online-status-large.online {
            background-color: #28a745; /* Online - green */
            box-shadow: 0 0 8px rgba(40, 167, 69, 0.8);
        }

    .online-status-text {
        font-size: 0.75rem;
        opacity: 0.9;
    }

    /* Sidebar styling */
    .list-group-item {
        border-left: none;
        border-right: none;
        transition: background-color 0.2s;
    }

        .list-group-item:first-child {
            border-top: none;
        }

        .list-group-item:hover {
            background-color: #f1f3f5;
        }

        .list-group-item.active {
            background-color: #0d6efd !important;
            border-color: #0d6efd !important;
        }

    /* Message bubble styling */
    .message-bubble {
        max-width: 70%;
        padding: 10px 14px;
        border-radius: 12px;
        word-wrap: break-word;
        position: relative;
    }

    .message-own {
        background-color: #0d6efd;
        color: white;
        border-bottom-right-radius: 4px;
    }

    .message-other {
        background-color: white;
        color: #212529;
        border: 1px solid #dee2e6;
        border-bottom-left-radius: 4px;
    }

    .message-content {
        word-break: break-word;
    }

    .message-time {
        font-size: 0.75rem;
        opacity: 0.7;
    }

    .message-status i {
        font-size: 1rem;
    }

    .message-footer {
        margin-top: 4px;
    }

    /* Read receipt colors */
    .bi-check-all.text-primary {
        color: #0dcaf0 !important; /* Light blue for read */
    }

    .bi-check.text-muted {
        color: #adb5bd !important; /* Gray for delivered */
    }
</style>

@section Scripts {
    <script src="~/lib/signalr/dist/browser/signalr.js"></script>
    <script>
        const currentUserId = '@currentUserId';
        const otherUserId = '@Model?.OtherUserId';
        const conversationId = @(ViewBag.ConversationId ?? 0);

        if (conversationId > 0 && otherUserId) {
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/chatHub")
                .withAutomaticReconnect()
                .build();

            // ═══════════════════════════════════════════════════════════
            // ONLINE/OFFLINE STATUS
            // ═══════════════════════════════════════════════════════════

            connection.on("UserOnline", function (userId) {
                console.log("User online:", userId);
                updateOnlineStatus(userId, true);
            });

            connection.on("UserOffline", function (userId) {
                console.log("User offline:", userId);
                updateOnlineStatus(userId, false);
            });

            function updateOnlineStatus(userId, isOnline) {
                // Update all status indicators for this user
                const statusElements = document.querySelectorAll(`[data-user-id="${userId}"]`);
                statusElements.forEach(element => {
                    if (element.classList.contains('online-status') || element.classList.contains('online-status-large')) {
                        if (isOnline) {
                            element.classList.add('online');
                        } else {
                            element.classList.remove('online');
                        }
                    } else if (element.classList.contains('online-status-text')) {
                        element.textContent = isOnline ? 'Online' : 'Offline';
                    }
                });
            }

            // ═══════════════════════════════════════════════════════════
            // READ RECEIPTS
            // ═══════════════════════════════════════════════════════════

            connection.on("MessagesRead", function (data) {
                console.log("Messages read:", data);

                data.messageIds.forEach(messageId => {
                    const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                    if (messageElement) {
                        const statusIcon = messageElement.querySelector('.message-status i');
                        if (statusIcon) {
                            // Change to double check (read) - blue
                            statusIcon.className = 'bi bi-check-all text-primary';
                            statusIcon.title = 'Read';
                        }
                    }
                });
            });

            // ═══════════════════════════════════════════════════════════
            // RECEIVE NEW MESSAGES
            // ═══════════════════════════════════════════════════════════

            connection.on("ReceivePrivateMessage", function (message) {
                if (message.senderId === otherUserId) {
                    addMessageToUI(message);

                    // Auto-mark as read
                    connection.invoke("MarkPrivateMessagesAsRead", conversationId, otherUserId)
                        .catch(err => console.error(err));
                }
            });

            // ═══════════════════════════════════════════════════════════
            // BADGE UPDATES
            // ═══════════════════════════════════════════════════════════

            connection.on("UpdateUnreadBadge", function (count) {
                const badges = document.querySelectorAll('.notification-badge');
                badges.forEach(badge => {
                    if (count > 0) {
                        badge.textContent = count;
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                });
            });

            // ═══════════════════════════════════════════════════════════
            // START CONNECTION
            // ═══════════════════════════════════════════════════════════

            connection.start()
                .then(function () {
                    console.log("SignalR Connected");

                    // Mark messages as read when opening conversation
                    connection.invoke("MarkPrivateMessagesAsRead", conversationId, otherUserId)
                        .catch(err => console.error(err));

                    // Request online status for other user
                    connection.invoke("GetUserOnlineStatus", otherUserId)
                        .catch(err => console.error(err));
                })
                .catch(function (err) {
                    console.error("SignalR Error:", err);
                });

            // ═══════════════════════════════════════════════════════════
            // HELPER FUNCTIONS
            // ═══════════════════════════════════════════════════════════

            function addMessageToUI(message) {
                const messageArea = document.getElementById('messageArea');
                const isOwn = message.senderId === currentUserId;

                const messageHTML = `
                    <div class="mb-3 d-flex ${isOwn ? 'justify-content-end' : 'justify-content-start'}">
                        <div class="message-bubble ${isOwn ? 'message-own' : 'message-other'}" data-message-id="${message.messageId || ''}">
                            ${!isOwn ? `<div class="message-sender fw-bold mb-1">${message.senderName}</div>` : ''}
                            <div class="message-content">${message.content}</div>
                            <div class="message-footer d-flex align-items-center justify-content-between mt-1">
                                <small class="message-time">${new Date(message.sentAt).toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit'})}</small>
                                ${isOwn ? `<span class="message-status ms-2"><i class="bi ${message.isRead ? 'bi-check-all text-primary' : 'bi-check text-muted'}" title="${message.isRead ? 'Read' : 'Delivered'}"></i></span>` : ''}
                            </div>
                        </div>
                    </div>
                `;

                messageArea.insertAdjacentHTML('beforeend', messageHTML);
                messageArea.scrollTop = messageArea.scrollHeight;
            }

            // Auto-scroll to bottom on page load
            document.addEventListener('DOMContentLoaded', function() {
                const messageArea = document.getElementById('messageArea');
                if (messageArea) {
                    messageArea.scrollTop = messageArea.scrollHeight;
                }
            });
        }
    </script>
}
