@using Microsoft.AspNetCore.Identity
@using OJTManagementSystem.Models
@inject UserManager<ApplicationUser> UserManager

@{
    ApplicationUser? currentUser = null;
    IList<string> roles = new List<string>();

    if (User?.Identity?.IsAuthenticated == true)
    {
        currentUser = await UserManager.GetUserAsync(User);
        if (currentUser != null)
        {
            roles = await UserManager.GetRolesAsync(currentUser);
        }
    }

    bool isSupervisor = roles.Contains("Supervisor");
    bool isIntern = roles.Contains("Intern");

    int unreadMessages = ViewBag.UnreadCount ?? 0;
    string currentAction = ViewContext.RouteData.Values["action"]?.ToString() ?? "";
    string currentController = ViewContext.RouteData.Values["controller"]?.ToString() ?? "";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - OJT Management</title>

    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
</head>

<body>

    @if (isSupervisor)
    {
        <!-- ===== SUPERVISOR SIDEBAR ===== -->
        <div class="sidebar p-3" id="mainSidebar">

            <!-- Brand -->
            <div class="sidebar-brand">
                <div class="brand-icon">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <div class="brand-text">
                    <span class="brand-title">OJT System</span>
                    <span class="brand-subtitle">Supervisor Portal</span>
                </div>
            </div>

            <!-- User Chip -->
            <div style="display:flex;align-items:center;gap:10px;padding:14px 10px 10px;margin-bottom:4px;">
                <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#5b5fc7,#7b61ff);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:0.85rem;flex-shrink:0;">
                    @(currentUser?.FullName?.Substring(0, 1).ToUpper() ?? "S")
                </div>
                <div>
                    <div style="color:#fff;font-size:0.8rem;font-weight:600;line-height:1.2;">@currentUser?.FullName</div>
                    <div style="color:#6e6e8a;font-size:0.7rem;">Supervisor</div>
                </div>
            </div>

            <!-- Main -->
            <h6>Main</h6>

            <a asp-controller="Supervisor" asp-action="Dashboard"
               class="@(currentController == "Supervisor" && currentAction == "Dashboard" ? "active" : "")">
                <i class="fas fa-chart-line"></i> Dashboard
            </a>

            <a asp-controller="Supervisor" asp-action="ManageInterns"
               class="@(currentAction == "ManageInterns" ? "active" : "")">
                <i class="fas fa-users"></i> Manage Interns
            </a>

            <!-- Approvals -->
            <h6>Approvals</h6>

            <a asp-controller="Supervisor" asp-action="ViewPendingDtrs"
               class="@(currentAction == "ViewPendingDtrs" ? "active" : "")">
                <i class="fas fa-clock"></i> Pending DTRs
            </a>

            <a asp-controller="Supervisor" asp-action="ViewPendingLeaves"
               class="@(currentAction == "ViewPendingLeaves" ? "active" : "")">
                <i class="fas fa-file-alt"></i> Leave Requests
            </a>

            <!-- Communication -->
            <h6>Communication</h6>

            <a asp-controller="Supervisor" asp-action="AllChats"
               class="@(currentAction == "AllChats" ? "active" : "")">
                <i class="fas fa-comments"></i> Messages
                @if (unreadMessages > 0)
                {
                    <span class="notification-badge">@unreadMessages</span>
                }
            </a>

            <hr />

            <form asp-controller="Account" asp-action="Logout" method="post" style="padding:0 2px;">
                <button type="submit" class="btn btn-danger w-100">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </form>
        </div>

        <!-- ===== SUPERVISOR CONTENT ===== -->
        <div class="content">
            <!-- Topbar -->
            <div class="topbar shadow-sm">
                <div>
                    <i class="fas fa-bars me-3 d-lg-none" id="sidebarToggle" style="cursor:pointer;color:#5b5fc7;"></i>
                    <strong>@ViewData["Title"]</strong>
                </div>
                <div>
                    <i class="fas fa-user-shield"></i>
                    @currentUser?.FullName
                </div>
            </div>

            <!-- Page Body -->
            <div style="padding:24px 28px;" class="stagger-children">
                @RenderBody()
            </div>
        </div>
    }
    else if (isIntern)
    {
        <!-- ===== INTERN SIDEBAR ===== -->
        <div class="sidebar p-3" id="mainSidebar">

            <!-- Brand -->
            <div class="sidebar-brand">
                <div class="brand-icon">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <div class="brand-text">
                    <span class="brand-title">OJT System</span>
                    <span class="brand-subtitle">Intern Portal</span>
                </div>
            </div>

            <!-- User Chip -->
            <div style="display:flex;align-items:center;gap:10px;padding:14px 10px 10px;margin-bottom:4px;">
                <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#0cba70,#3dd68c);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:0.85rem;flex-shrink:0;">
                    @(currentUser?.FullName?.Substring(0, 1).ToUpper() ?? "I")
                </div>
                <div>
                    <div style="color:#fff;font-size:0.8rem;font-weight:600;line-height:1.2;">@currentUser?.FullName</div>
                    <div style="color:#6e6e8a;font-size:0.7rem;">Intern</div>
                </div>
            </div>

            <!-- Main -->
            <h6>Main</h6>

            <a asp-controller="Intern" asp-action="Dashboard"
               class="@(currentController == "Intern" && currentAction == "Dashboard" ? "active" : "")">
                <i class="fas fa-home"></i> Dashboard
            </a>

            <!-- DTR -->
            <h6>Daily Time Record</h6>

            <a asp-controller="Intern" asp-action="SubmitDtr"
               class="@(currentAction == "SubmitDtr" ? "active" : "")">
                <i class="fas fa-clock"></i> Submit DTR
            </a>

            <a asp-controller="Intern" asp-action="ViewDtrs"
               class="@(currentAction == "ViewDtrs" ? "active" : "")">
                <i class="fas fa-list-alt"></i> View DTRs
            </a>

            <!-- Leave -->
            <h6>Leave</h6>

            <a asp-controller="Intern" asp-action="RequestLeave"
               class="@(currentAction == "RequestLeave" ? "active" : "")">
                <i class="fas fa-calendar-times"></i> Request Leave
            </a>

            <a asp-controller="Intern" asp-action="ViewLeaveRequests"
               class="@(currentAction == "ViewLeaveRequests" ? "active" : "")">
                <i class="fas fa-file-alt"></i> My Leaves
            </a>

            <!-- Evaluation -->
            <h6>Evaluation</h6>

            <a asp-controller="Intern" asp-action="ViewEvaluation"
               class="@(currentAction == "ViewEvaluation" ? "active" : "")">
                <i class="fas fa-star"></i> My Evaluations
            </a>

            <a asp-controller="Intern" asp-action="ViewCertificate"
               class="@(currentAction == "ViewCertificate" ? "active" : "")">
                <i class="fas fa-award"></i> Certificate
            </a>

            <!-- Communication -->
            <h6>Communication</h6>

            <a asp-controller="Intern" asp-action="AllChats"
               class="@(currentAction == "AllChats" ? "active" : "")">
                <i class="fas fa-comments"></i> Messages
                @if (unreadMessages > 0)
                {
                    <span class="notification-badge">@unreadMessages</span>
                }
            </a>

            <hr />

            <form asp-controller="Account" asp-action="Logout" method="post" style="padding:0 2px;">
                <button type="submit" class="btn btn-danger w-100">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </form>
        </div>

        <!-- ===== INTERN CONTENT ===== -->
        <div class="content">
            <!-- Topbar -->
            <div class="topbar shadow-sm">
                <div>
                    <i class="fas fa-bars me-3 d-lg-none" id="sidebarToggle" style="cursor:pointer;color:#5b5fc7;"></i>
                    <strong>@ViewData["Title"]</strong>
                </div>
                <div>
                    <i class="fas fa-user-graduate"></i>
                    @currentUser?.FullName
                </div>
            </div>

            <!-- Page Body -->
            <div style="padding:24px 28px;" class="stagger-children">
                @RenderBody()
            </div>
        </div>
    }
    else
    {
        <!-- ===== PUBLIC NAVBAR ===== -->
        <nav class="navbar navbar-expand-lg navbar-dark shadow-sm">
            <div class="container-fluid px-4">
                <a class="navbar-brand" asp-controller="Home" asp-action="Index">
                    <i class="fas fa-graduation-cap me-2"></i> OJT Management System
                </a>

                <div class="collapse navbar-collapse">
                    <ul class="navbar-nav ms-auto">
                        @if (User.Identity!.IsAuthenticated)
                        {
                            <li class="nav-item ms-3">
                                <form asp-controller="Account" asp-action="Logout" method="post">
                                    <button type="submit" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-sign-out-alt me-1"></i> Logout
                                    </button>
                                </form>
                            </li>
                        }
                    </ul>
                </div>
            </div>
        </nav>

        <main class="container my-4">
            @RenderBody()
        </main>
    }

    <!-- ========================================
         TOAST NOTIFICATION CONTAINER
         ======================================== -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">

        @* Success Messages *@
        @if (TempData["Success"] != null || TempData["SuccessMessage"] != null)
        {
            var successMsg = TempData["Success"]?.ToString() ?? TempData["SuccessMessage"]?.ToString();
            <div class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-check-circle me-2"></i>
                        @successMsg
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        }

        @* Error Messages *@
        @if (TempData["Error"] != null || TempData["ErrorMessage"] != null)
        {
            var errorMsg = TempData["Error"]?.ToString() ?? TempData["ErrorMessage"]?.ToString();
            <div class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        @errorMsg
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        }

        @* Info Messages — supports optional "View Messages" link button *@
        @if (TempData["Info"] != null || TempData["InfoMessage"] != null)
        {
            var infoMsg = TempData["Info"]?.ToString() ?? TempData["InfoMessage"]?.ToString();
            var infoLinkUrl = TempData["InfoLinkUrl"]?.ToString();
            var infoLinkText = TempData["InfoLinkText"]?.ToString();

            <div class="toast align-items-center text-bg-info border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex flex-column">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="fas fa-envelope me-2"></i>
                            @infoMsg
                        </div>
                        <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                    @* ✅ Only show the link button when InfoLinkUrl is set (i.e. new messages notification) *@
                    @if (!string.IsNullOrEmpty(infoLinkUrl))
                    {
                        <div class="px-3 pb-2">
                            <a href="@infoLinkUrl" class="btn btn-sm btn-dark w-100">
                                <i class="fas fa-comments me-1"></i> @infoLinkText
                            </a>
                        </div>
                    }
                </div>
            </div>
        }

        @* Warning Messages *@
        @if (TempData["Warning"] != null || TempData["WarningMessage"] != null)
        {
            var warningMsg = TempData["Warning"]?.ToString() ?? TempData["WarningMessage"]?.ToString();
            <div class="toast align-items-center text-bg-warning border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        @warningMsg
                    </div>
                    <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        }

    </div>

    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        function formatTime(timeString) {
            if (!timeString) return '';
            const [hours, minutes] = timeString.split(':');
            return `${hours}:${minutes}`;
        }

        function calculateHours(timeIn, timeOut) {
            if (!timeIn || !timeOut) return 0;
            const [inHours, inMinutes] = timeIn.split(':').map(Number);
            const [outHours, outMinutes] = timeOut.split(':').map(Number);
            const inTotalMinutes = inHours * 60 + inMinutes;
            const outTotalMinutes = outHours * 60 + outMinutes;
            let diffMinutes = outTotalMinutes - inTotalMinutes;
            if (diffMinutes < 0) { diffMinutes += 24 * 60; }
            return (diffMinutes / 60).toFixed(2);
        }

        function confirmAction(message) { return confirm(message); }

        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) return;
            const toastId = 'toast-' + Date.now();
            const bgClass = type === 'success' ? 'text-bg-success' :
                            type === 'error'   ? 'text-bg-danger'  :
                            type === 'warning' ? 'text-bg-warning' : 'text-bg-info';
            const icon = type === 'success' ? 'fa-check-circle' :
                         type === 'error'   ? 'fa-exclamation-circle' :
                         type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle';
            const closeClass = (type === 'warning' || type === 'info') ? 'btn-close' : 'btn-close btn-close-white';
            const toastHTML = `
                <div id="${toastId}" class="toast align-items-center ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body"><i class="fas ${icon} me-2"></i>${message}</div>
                        <button type="button" class="${closeClass} me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>`;
            toastContainer.insertAdjacentHTML('beforeend', toastHTML);
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { autohide: true, delay: 5000 });
            toast.show();
            toastElement.addEventListener('hidden.bs.toast', function () { toastElement.remove(); });
        }

        function showError(message)   { showToast(message, 'error'); }
        function showSuccess(message) { showToast(message, 'success'); }
        function showInfo(message)    { showToast(message, 'info'); }
        function showWarning(message) { showToast(message, 'warning'); }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => { clearTimeout(timeout); func(...args); };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function getQueryParameter(name) {
            return new URLSearchParams(window.location.search).get(name);
        }

        function initializeValidation() {
            const forms = document.querySelectorAll('form[novalidate]');
            forms.forEach(form => {
                form.addEventListener('submit', function (e) {
                    if (!form.checkValidity()) { e.preventDefault(); e.stopPropagation(); }
                    form.classList.add('was-validated');
                });
            });
        }

        function initializeToasts() {
            const toastElements = document.querySelectorAll('.toast');
            toastElements.forEach(toastElement => {
                const toast = new bootstrap.Toast(toastElement, { autohide: true, delay: 6000 });
                toast.show();
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            initializeValidation();
            initializeToasts();

            const alerts = document.querySelectorAll('.alert:not(.alert-permanent)');
            alerts.forEach(alert => {
                setTimeout(() => { new bootstrap.Alert(alert).close(); }, 5000);
            });

            const toggleBtn = document.getElementById('sidebarToggle');
            const sidebar   = document.getElementById('mainSidebar');
            if (toggleBtn && sidebar) {
                toggleBtn.addEventListener('click', () => { sidebar.classList.toggle('show'); });
                document.addEventListener('click', (e) => {
                    if (window.innerWidth < 769 && sidebar.classList.contains('show')) {
                        if (!sidebar.contains(e.target) && e.target !== toggleBtn) {
                            sidebar.classList.remove('show');
                        }
                    }
                });
            }
        });

        document.addEventListener('change', function (e) {
            if (e.target.name === 'TimeIn' || e.target.name === 'TimeOut') {
                const timeInInput  = document.querySelector('input[name="TimeIn"]');
                const timeOutInput = document.querySelector('input[name="TimeOut"]');
                const hoursDisplay = document.querySelector('.total-hours');
                if (timeInInput && timeOutInput && hoursDisplay) {
                    hoursDisplay.textContent = `Total Hours: ${calculateHours(timeInInput.value, timeOutInput.value)}`;
                }
            }
        });
    </script>

    <!-- ✅ SignalR for Real-Time Badge Updates -->
    <script src="~/lib/signalr/dist/browser/signalr.js"></script>
    @if (User?.Identity?.IsAuthenticated == true)
    {
        <script>
            (function() {
                const connection = new signalR.HubConnectionBuilder()
                    .withUrl("/chatHub")
                    .withAutomaticReconnect()
                    .build();

                connection.on("UpdateUnreadBadge", function (count) {
                    const badges = document.querySelectorAll('.notification-badge');
                    badges.forEach(badge => {
                        if (count > 0) {
                            badge.textContent = count;
                            badge.style.display = 'inline-block';
                        } else {
                            badge.style.display = 'none';
                        }
                    });
                });

                connection.start()
                    .then(() => console.log("SignalR Connected - Badge updates enabled"))
                    .catch(err => console.error("SignalR Error:", err));
            })();
        </script>
    }

    @await RenderSectionAsync("Scripts", required: false)

</body>
</html>